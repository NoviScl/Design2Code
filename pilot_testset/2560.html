<!DOCTYPE html>
<html lang="en">
 <head>
  <style>
   body,h1,h2,h3,h4,h5,h6,p,blockquote,pre,hr,dl,dd,ol,ul,figure{margin:0;padding:0}body{font:400 16px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";color:#111;background-color:#fdfdfd;-webkit-text-size-adjust:100%;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1;font-feature-settings:"kern" 1;font-kerning:normal;display:flex;min-height:100vh;flex-direction:column}h1,h2,h3,h4,h5,h6,p,blockquote,pre,ul,ol,dl,figure,.highlight{margin-bottom:15px}main{display:block}img{max-width:100%;vertical-align:middle}figure>img{display:block}figcaption{font-size:14px}ul,ol{margin-left:30px}li>ul,li>ol{margin-bottom:0}h1,h2,h3,h4,h5,h6{font-weight:400}a{color:#2a7ae2;text-decoration:none}a:visited{color:#1756a9}a:hover{color:#111;text-decoration:underline}.social-media-list a:hover{text-decoration:none}.social-media-list a:hover .username{text-decoration:underline}blockquote{color:#828282;border-left:4px solid #e8e8e8;padding-left:15px;font-size:18px;letter-spacing:-1px;font-style:italic}blockquote>:last-child{margin-bottom:0}pre,code{font-size:15px;border:1px solid #e8e8e8;border-radius:3px;background-color:#eef}code{padding:1px 5px}pre{padding:8px 12px;overflow-x:auto}pre>code{border:0;padding-right:0;padding-left:0}.wrapper{max-width:-webkit-calc(800px - (30px * 2));max-width:calc(800px - (30px * 2));margin-right:auto;margin-left:auto;padding-right:30px;padding-left:30px}@media screen and (max-width: 800px){.wrapper{max-width:-webkit-calc(800px - (30px));max-width:calc(800px - (30px));padding-right:15px;padding-left:15px}}.wrapper:after,.footer-col-wrapper:after{content:"";display:table;clear:both}.svg-icon{width:16px;height:16px;display:inline-block;fill:#828282;padding-right:5px;vertical-align:text-top}.social-media-list li+li{padding-top:5px}table{margin-bottom:30px;width:100%;text-align:left;color:#3f3f3f;border-collapse:collapse;border:1px solid #e8e8e8}table tr:nth-child(even){background-color:#f7f7f7}table th,table td{padding:10px 15px}table th{background-color:#f0f0f0;border:1px solid #dedede;border-bottom-color:#c9c9c9}table td{border:1px solid #e8e8e8}.site-header{border-top:5px solid #424242;border-bottom:1px solid #e8e8e8;min-height:55.95px;position:relative}.site-title{font-size:26px;font-weight:300;line-height:54px;letter-spacing:-1px;margin-bottom:0;float:left}.site-title,.site-title:visited{color:#424242}.site-nav{float:right;line-height:54px}.site-nav .nav-trigger{display:none}.site-nav .menu-icon{display:none}.site-nav .page-link{color:#111;line-height:1.5}.site-nav .page-link:not(:last-child){margin-right:20px}@media screen and (max-width: 600px){.site-nav{position:absolute;top:9px;right:15px;background-color:#fdfdfd;border:1px solid #e8e8e8;border-radius:5px;text-align:right}.site-nav label[for="nav-trigger"]{display:block;float:right;width:36px;height:36px;z-index:2;cursor:pointer}.site-nav .menu-icon{display:block;float:right;width:36px;height:26px;line-height:0;padding-top:10px;text-align:center}.site-nav .menu-icon>svg{fill:#424242}.site-nav input ~ .trigger{clear:both;display:none}.site-nav input:checked ~ .trigger{display:block;padding-bottom:5px}.site-nav .page-link{display:block;padding:5px 10px;margin-left:20px}.site-nav .page-link:not(:last-child){margin-right:0}}.site-footer{border-top:1px solid #e8e8e8;padding:30px 0}.footer-heading{font-size:18px;margin-bottom:15px}.contact-list,.social-media-list{list-style:none;margin-left:0}.footer-col-wrapper{font-size:15px;color:#828282;margin-left:-15px}.footer-col{float:left;margin-bottom:15px;padding-left:15px}.footer-col-1{width:-webkit-calc(35% - (30px / 2));width:calc(35% - (30px / 2))}.footer-col-2{width:-webkit-calc(20% - (30px / 2));width:calc(20% - (30px / 2))}.footer-col-3{width:-webkit-calc(45% - (30px / 2));width:calc(45% - (30px / 2))}@media screen and (max-width: 800px){.footer-col-1,.footer-col-2{width:-webkit-calc(50% - (30px / 2));width:calc(50% - (30px / 2))}.footer-col-3{width:-webkit-calc(100% - (30px / 2));width:calc(100% - (30px / 2))}}@media screen and (max-width: 600px){.footer-col{float:none;width:-webkit-calc(100% - (30px / 2));width:calc(100% - (30px / 2))}}.page-content{padding:30px 0;flex:1}.page-heading{font-size:32px}.post-list-heading{font-size:28px}.post-list{margin-left:0;list-style:none}.post-list>li{margin-bottom:30px}.post-meta{font-size:14px;color:#828282}.post-link{display:block;font-size:24px}.post-header{margin-bottom:30px}.post-title{font-size:42px;letter-spacing:-1px;line-height:1}@media screen and (max-width: 800px){.post-title{font-size:36px}}.post-content{margin-bottom:30px}.post-content h2{font-size:32px}@media screen and (max-width: 800px){.post-content h2{font-size:28px}}.post-content h3{font-size:26px}@media screen and (max-width: 800px){.post-content h3{font-size:22px}}.post-content h4{font-size:20px}@media screen and (max-width: 800px){.post-content h4{font-size:18px}}.highlight{background:#fff}.highlighter-rouge .highlight{background:#eef}.highlight .c{color:#998;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#998;font-style:italic}.highlight .cp{color:#999;font-weight:bold}.highlight .c1{color:#998;font-style:italic}.highlight .cs{color:#999;font-weight:bold;font-style:italic}.highlight .gd{color:#000;background-color:#fdd}.highlight .gd .x{color:#000;background-color:#faa}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000;background-color:#dfd}.highlight .gi .x{color:#000;background-color:#afa}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaa}.highlight .gt{color:#a00}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#458;font-weight:bold}.highlight .m{color:#099}.highlight .s{color:#d14}.highlight .na{color:teal}.highlight .nb{color:#0086B3}.highlight .nc{color:#458;font-weight:bold}.highlight .no{color:teal}.highlight .ni{color:purple}.highlight .ne{color:#900;font-weight:bold}.highlight .nf{color:#900;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:navy}.highlight .nv{color:teal}.highlight .ow{font-weight:bold}.highlight .w{color:#bbb}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .sb{color:#d14}.highlight .sc{color:#d14}.highlight .sd{color:#d14}.highlight .s2{color:#d14}.highlight .se{color:#d14}.highlight .sh{color:#d14}.highlight .si{color:#d14}.highlight .sx{color:#d14}.highlight .sr{color:#009926}.highlight .s1{color:#d14}.highlight .ss{color:#990073}.highlight .bp{color:#999}.highlight .vc{color:teal}.highlight .vg{color:teal}.highlight .vi{color:teal}.highlight .il{color:#099}
  </style>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
  <title>
   Emacs redraw issue in X.org on VMWare and VirtualBox | fujii.github.io
  </title>
  <meta content="Jekyll v3.9.3" name="generator">
  <meta content="Emacs redraw issue in X.org on VMWare and VirtualBox" property="og:title">
  <meta content="en_US" property="og:locale">
  <meta content="Issue" name="description">
  <meta content="Issue" property="og:description">
  <meta content="https://fujii.github.io/2016/09/06/emacs-redisplay-issue-on-vmware/" property="og:url">
  <meta content="fujii.github.io" property="og:site_name">
  <meta content="article" property="og:type">
  <meta content="2016-09-06T00:00:00+09:00" property="article:published_time">
  <meta content="summary" name="twitter:card">
  <meta content="Emacs redraw issue in X.org on VMWare and VirtualBox" property="twitter:title">
  <!-- End Jekyll SEO tag -->
 </head>
 <body>
  <header class="site-header" role="banner">
   <div class="wrapper">
    <a class="site-title" rel="author">
     fujii.github.io
    </a>
    <nav class="site-nav">
     <input class="nav-trigger" id="nav-trigger" type="checkbox">
     <label for="nav-trigger">
      <span class="menu-icon">
      </span>
     </label>
     <div class="trigger">
     </div>
    </nav>
   </div>
  </header>
  <main aria-label="Content" class="page-content">
   <div class="wrapper">
    <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
     <header class="post-header">
      <h1 class="post-title p-name" itemprop="name headline">
       Emacs redraw issue in X.org on VMWare and VirtualBox
      </h1>
      <p class="post-meta">
       <time class="dt-published" datetime="2016-09-06T00:00:00+09:00" itemprop="datePublished">
        Sep 6, 2016
       </time>
      </p>
     </header>
     <div class="post-content e-content" itemprop="articleBody">
      <h2 id="issue">
       Issue
      </h2>
      <p>
       Emacs redraws sometimes partially while scrolling in X.org on VMWare or VirtualBox.
I tested only on Windows host OS.
      </p>
      <p>
       Following error messages are output in
       <code class="language-plaintext highlighter-rouge">
        /var/log/Xorg.0.log
       </code>
       when this problem occurs.
      </p>
      <div class="language-plaintext highlighter-rouge">
       <div class="highlight">
        <pre class="highlight"><code>[  1278.046] (EE) vmwgfx_scanout_update: failed to send dirty (-22, Invalid argument)
</code></pre>
       </div>
      </div>
      <p>
       There are many reports of this problem:
      </p>
      <ul>
       <li>
        <a>
         Super User: ubuntu - Emacs does not redraw properly inside VirtualBox
        </a>
       </li>
       <li>
        <a>
         Oracle VM VirtualBox: #13687 (Emacs redraw issues with &gt;1 Virtualbox CPU)
        </a>
       </li>
      </ul>
      <p>
       I confirmed it happens even in one CPU configuration.
      </p>
      <p>
       Vim seems to have the similar problems:
      </p>
      <ul>
       <li>
        <a>
         Stack Overflow: linux - Gvim redraw issues with Virtual Box and Windows 7 host
        </a>
       </li>
       <li>
        <a>
         Debian Bug report: #777567 - vim-gtk: Regions of text fail to redraw in gvim
        </a>
       </li>
       <li>
        <a>
         Super User: vim - gvim redraw failure
        </a>
       </li>
      </ul>
      <h2 id="workarounds">
       Workarounds
      </h2>
      <p>
       There are several workarounds I tried.
      </p>
      <h3 id="use-cairo">
       Use Cairo
      </h3>
      <p>
       Emacs 25 supports Cairo by
       <code class="language-plaintext highlighter-rouge">
        configure --with-cario
       </code>
       .
This workaround does not hide the problem completely.
This makes it less frequently.
      </p>
      <h3 id="synchronous-mode">
       Synchronous mode
      </h3>
      <div class="language-plaintext highlighter-rouge">
       <div class="highlight">
        <pre class="highlight"><code>  emacs -xrm "emacs.synchronous: true"
</code></pre>
       </div>
      </div>
      <p>
       This makes Emacs somewhat slow.
      </p>
      <h3 id="call-redraw-display-after-scroll">
       Call redraw-display after scroll
      </h3>
      <div class="language-elisp highlighter-rouge">
       <div class="highlight">
        <pre class="highlight"><code><span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">eq</span> <span class="nv">window-system</span> <span class="ss">'x</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">'window-scroll-functions</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nv">run-with-idle-timer</span> <span class="mf">0.5</span> <span class="no">nil</span> <span class="ss">'redraw-display</span><span class="p">))))</span>
</code></pre>
       </div>
      </div>
      <h3 id="use-compiz">
       Use compiz
      </h3>
      <p>
       Using compiz solves the problem.
Unfortunately, compiz makes painting slow.
      </p>
      <h3 id="use-xephyr">
       Use Xephyr
      </h3>
      <p>
       Xephyr also solve the problem.
On the other hand, Xnest doesn&rsquo;t help.
      </p>
      <h3 id="use-xorg-fbdev-driver">
       Use X.Org fbdev driver
      </h3>
      <p>
       <code class="language-plaintext highlighter-rouge">
        /etc/X11/xorg.conf
       </code>
       :
      </p>
      <div class="language-plaintext highlighter-rouge">
       <div class="highlight">
        <pre class="highlight"><code>Section "Device"
	Identifier "card 0"
	Driver "fbdev"
EndSection
</code></pre>
       </div>
      </div>
      <h3 id="switch-wallpaper-images-every-seconds">
       Switch wallpaper images every seconds
      </h3>
      <p>
       This triggers repainting whole scrren every seconds.
      </p>
      <h3 id="switch-to-other-window-and-back-to-emacs">
       Switch to other window and back to Emacs
      </h3>
      <p>
       Press Alt-Tab and Alt-Tab to switch window to repaint.
      </p>
      <h2 id="investigation">
       Investigation
      </h2>
      <p>
       libX11 API calls can be observed by
       <code class="language-plaintext highlighter-rouge">
        ltrace
       </code>
       :
      </p>
      <div class="language-plaintext highlighter-rouge">
       <div class="highlight">
        <pre class="highlight"><code>ltrace -l libX11\* emacs
</code></pre>
       </div>
      </div>
      <p>
       The following API are called frequently during scroll.
      </p>
      <div class="language-plaintext highlighter-rouge">
       <div class="highlight">
        <pre class="highlight"><code>emacs-&gt;XDrawImageString(0x306e800, 0x28000b0, 0x3b47ee0, 264) = 0
emacs-&gt;XSetClipMask(0x306e800, 0x3b47ee0, 0, 0)             = 1
emacs-&gt;XSetClipRectangles(0x306e800, 0x3b47ee0, 0, 0)       = 1
emacs-&gt;XDrawImageString(0x306e800, 0x28000b0, 0x3b47ee0, 296) = 0
emacs-&gt;XSetClipMask(0x306e800, 0x3b47ee0, 0, 0)             = 1
emacs-&gt;XSetClipRectangles(0x306e800, 0x3b47ee0, 0, 0)       = 1
</code></pre>
       </div>
      </div>
      <p>
       I created a test program and filed
       <a>
        a bug report
       </a>
       .
      </p>
      <h2 id="apply-a-patch-and-compile-the-driver">
       Apply a patch and compile the driver
      </h2>
      <p>
       I attached
       <a>
        my patch
       </a>
       .
      </p>
      <p>
       This is the install steps for Fedora.
      </p>
      <div class="language-sh highlighter-rouge">
       <div class="highlight">
        <pre class="highlight"><code>dnf download <span class="nt">--source</span> xorg-x11-drv-vmware
<span class="nb">sudo </span>dnf builddep xorg-x11-drv-vmware
aunpack xorg-x11-drv-vmware-13.0.2-11.20150211git8f0cf7c.fc24.src.rpm
aunpack xorg-x11-drv-vmware-13.0.2-11.20150211git8f0cf7c.fc24.src/xf86-video-vmware-20150211.tar.bz2
<span class="nb">cd </span>xf86-video-vmware-20150211
patch <span class="nt">-p0</span> ~/tmp/vmwgfx-dirty-union.patch
autoreconf <span class="nt">-isv</span>
./configure <span class="nt">--prefix</span><span class="o">=</span><span class="nv">$HOME</span>/opt
make 
make <span class="nb">install</span> 
</code></pre>
       </div>
      </div>
      <p>
       Create
       <code class="language-plaintext highlighter-rouge">
        /etc/X11/xorg.conf
       </code>
       with the following content.
      </p>
      <div class="language-plaintext highlighter-rouge">
       <div class="highlight">
        <pre class="highlight"><code>Section "Files"
    ModulePath "/home/fujii/opt/lib/xorg/modules,/usr/lib64/xorg/modules"
EndSection
</code></pre>
       </div>
      </div>
      <p>
       Log out and log in (lightdm restarts X server).
      </p>
      <p>
       See the log
       <code class="language-plaintext highlighter-rouge">
        /var/log/Xorg.0.log
       </code>
       to check your driver is loaded.
      </p>
      <p>
       This is for Ubuntu 17.4:
      </p>
      <div class="language-sh highlighter-rouge">
       <div class="highlight">
        <pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>devscripts
<span class="nb">sudo </span>apt-get build-dep xserver-xorg-video-vmware
apt-get <span class="nb">source </span>xserver-xorg-video-vmware
<span class="nb">cd </span>xserver-xorg-video-vmware-13.2.1
patch <span class="nt">-p0</span> &lt; ../vmwgfx-dirty-union.patch
debuild <span class="nt">-i</span> <span class="nt">-us</span> <span class="nt">-uc</span> <span class="nt">-b</span>
<span class="nb">cd</span> ..
<span class="nb">sudo </span>dpkg <span class="nt">-i</span> xserver-xorg-video-vmware_13.2.1-1build1_amd64.deb
</code></pre>
       </div>
      </div>
     </div>
     <a class="u-url" hidden>
     </a>
    </article>
   </div>
  </main>
  <footer class="site-footer h-card">
   <data class="u-url">
   </data>
   <div class="wrapper">
    <h2 class="footer-heading">
     fujii.github.io
    </h2>
    <div class="footer-col-wrapper">
     <div class="footer-col footer-col-1">
      <ul class="contact-list">
       <li class="p-name">
        fujii.github.io
       </li>
       <li>
        <a class="u-email">
         fujii.hironori@gmail.com
        </a>
       </li>
      </ul>
     </div>
     <div class="footer-col footer-col-2">
      <ul class="social-media-list">
       <li>
        <a>
         <span class="username">
          fujii
         </span>
        </a>
       </li>
       <li>
        <a>
         <span class="username">
          fujii0
         </span>
        </a>
       </li>
      </ul>
     </div>
     <div class="footer-col footer-col-3">
      <p>
       Fujii Hironori's Random Notes
      </p>
     </div>
    </div>
   </div>
  </footer>
 </body>
</html>
